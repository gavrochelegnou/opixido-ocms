#labels Documentation
= Base de données =

<h2>Pré-requis</h2>
Vous devez configurer la connexion à la base de données dans le fichier _config.server.php_ se situant dans le dossier _include/config/_ :

<code>
$_bdd_user = 'root';
$_bdd_pwd = '';
$_bdd_bdd = 'database';
$_bdd_host = 'localhost';
$_bdd_type = 'mysql';
</code>

OCMS utilise les fonctions de la librairie PHP ADOdb pour se connecter au SGBD.

<h2>Les fonctions</h2>

<ul>
<li>
*Exécuter une requête SQL*
<code> 
/* @param string $sql
 * @param string $msg Message en cas d'erreur
 * @return ADORecordSet $res
 */
doSql($sql, $msg=''); 
</code>

Exemple :
<code>
$res = doSql(' UPDATE user SET age=30 WHERE user_id=2 ');
if($res) echo 'Réussi';
</code>

</li>

<li>
*Récupérer l'ensemble des résultats d'une requête sous forme de tableau*
<code>
/* @param string $sql
 * @param bool $cache
 * @param string $connexion
 * @return array
 */
getAll($sql, $cache=0, $connexion='');
</code>

Exemple :
<code>
$users = getAll(' SELECT * FROM user ');
foreach($users as $user)
{
 echo $user['nom'];
}
</code>

</li>

<li>
*Récupérer le premier enregistrement d'une requête*
<code>
/* @param string  $sql
 * @param bool $cache
 * @param string $connexion
 * @return array
 */
getSingle($sql, $cache=0, $connexion='');
</code>

Exemple : 
<code>
$user = getSingle(' SELECT * FROM user WHERE user_id=2 ');
echo $user['nom'];
</code>
</li>

<li>
*Ajouter un paramètre dans une requête SQL*
<code>
/* @param string $param
 * @param string $type int ou string
 * @return string
 */
sql($param, $type='string');
</code>

Exemple :
<code>
$user = getSingle(' SELECT * FROM user WHERE user_id = '.sql($_REQUEST['id'], 'int'));
//Valeur de retour : 'SELECT * FROM user WHERE user_id = "2" '
</code>
</li>

<li>
*Récupérer le dernier identifiant inséré*
<code>
/* @return mixed
*/
InsertId();
</code>
Exemple :
<code>
$res = doSql('INSERT INTO user(nom) VALUES('.sql($nom).') ');
if($res) echo 'Correctement enregistré sous l'id '.InsertId();
</code>
</li>

<li>
*Récupérer un enregistrement à partir de la table et de l'identifiant de la ligne*
<code>
/* @param string $table
 * @param string $type int ou string
 * @param boolean $onlyOnline
 * @return array
 */
getRowFromId($table, $id, $onlyOnline=false);
</code>

Exemple :
<code>
$row = getRowFromId('user', 2);
//Equivalent : getSingle(' SELECT * FROM user WHERE user_id = 2 ');
</code>

</li>

<li>
*Récupérer un enregistrement à partir de la table, du champ et d'une valeur*
<code>
/* @param string $table
 * @param string $champ
 * @param string $val
 * @return array
 */
getRowFromFieldLike($table, $champ, $val);
</code>

Exemple :
<code>
$row = getRowFromFieldLike('user', 'nom', 'Martin');
//Equivalent : getSingle(' SELECT * FROM user WHERE user_nom LIKE '.sql('Martin'));
</code>

</li>

<li>
*Ne récupérer que les enregistrements en ligne*
Pré-requis : la table doit posséder l'attribut _"en_ligne"_
<code>
/* @param string $table
 * @param string $alias
 * @return string
 */
sqlOnlyOnline($table, $alias='');
</code>

Exemple :
<code>
//Ne récupérer que les news en ligne
$res = getAll('SELECT * FROM news WHERE 1 '.sqlOnlyOnline('news'));
</code>

</li>

<li>
*Ne récupérer que les enregistrements de version validée*
Pré-requis : la table doit posséder les attributs _"en_ligne"_ et _"fk_version"_
<code>
sqlVersionOline($table, $alias='');
</code>

Exemple :
<code>
//Ne récupérer que les rubriques validées et en ligne
$res = getAll('SELECT * FROM s_rubrique WHERE 1'.sqlVersionOnline('s_rubrique'));
</code>
</li>

<li>
Récupérer la liste des champs d'une table
<code>
/* @param string $table
 * @return array
*/
getTableField($table);
</code>
</li>

<li>
Récupérer le nombre d'enregistrements MySQL affectés par la dernière requête
<code language="php">
/* @return array 
*/
Affected_Rows();
</code>
</li>

<li>
Tester une requête SQL.
La fonction exécute la requête et retourne un message d'erreur si elle n'aboutit pas.
<code language="php">
/* @param string $sql
 * @return mixed
*/
TrySql($sql);
</code>
</li>

<li>
Récupérer la liste des tables
<code>
/* @return array
*/
getTables();
</code>
</li>

</ul>